/*
    Salt Typhoon (Earth Estries) - YARA Detection Rules
    
    Author:      Moo
    Created:     2026-02-17
    Version:     1.0
    Description: TTP-based detection rule for Salt Typhoon Cisco device exploitation.
                 TTP-based behavioral detection targeting command patterns unique to
                 Salt Typhoon's Cisco router exploitation methodology.
    
    Sources:
        [1] CISA Advisory AA25-239A (August 2025)
        [2] Trend Micro - "Game of Emperor: Earth Estries" (November 2024)
        [3] Darktrace - "Salty Much: Salt Typhoon intrusion" (October 2025)
        [4] Rapid7 - "Salt Typhoon: Threat Assessment" (August 2025)
    
    NOTE: These rules are IOC-based, derived from published threat intelligence
    rather than binary samples. For production deployment, validate against your
    environment's baseline to tune false positives.

    License: MIT
*/




// =============================================================================
// Salt Typhoon Cisco Router Exploitation Artifacts
// Approach: TTP-based behavioral detection targeting command patterns unique
//           to Salt Typhoon's network device exploitation methodology.
// Sources: CISA AA25-239A [1], Rapid7 [4]
// =============================================================================

rule SaltTyphoon_Cisco_Exploitation
{
    meta:
        description     = "Detects command patterns and tool artifacts from Salt Typhoon exploitation of Cisco IOS/IOS-XE/NX-OS network devices, including TACACS+ credential redirection, GRE tunnel exfiltration, Guest Shell container abuse, and custom tooling"
        author          = "Moo"
        date            = "2026-02-17"
        version         = "1.0"
        threat_actor    = "Salt Typhoon"
        mitre_attack    = "T1562.004 - Disable or Modify System Firewall, T1556 - Modify Authentication Process, T1040 - Network Sniffing, T1572 - Protocol Tunneling, T1610 - Deploy Container, T1602 - Data from Configuration Repository"
        reference_1     = "https://www.cisa.gov/resources-tools/resources/enhanced-visibility-and-hardening-guidance-communications-infrastructure"
        reference_2     = "https://www.rapid7.com/blog/post/2025/08/07/salt-typhoon-threat-assessment/"
        severity        = "CRITICAL"
        note            = "Scan against router config exports, command logs, shell history, syslog, and PCAP files"

    strings:
        // --- TACACS+ credential harvesting (T1556) ---
        // Salt Typhoon redirects TACACS+ to attacker-controlled servers to intercept credentials
        $tacacs_1       = "tacacs-server host" ascii nocase
        $tacacs_2       = "tacacs server" ascii nocase
        
        // --- GRE tunnel data exfiltration (T1572) ---
        // Salt Typhoon creates GRE tunnels to mirror and exfiltrate intercepted traffic
        $gre_1          = "tunnel mode gre" ascii nocase
        $gre_2          = "interface Tunnel" ascii nocase
        
        // --- ACL modification (T1562.004) ---
        // Firewall rules modified to permit attacker traffic
        $acl_mod        = "access-list" ascii nocase
        
        // --- Network sniffing on router (T1040) ---
        // Packet capture configured directly on compromised network devices
        $capture_1      = "monitor capture" ascii nocase
        $capture_2      = "ip traffic-export" ascii nocase
        
        // --- Guest Shell container abuse (T1610) ---
        // Linux containers on Cisco devices used to run Python scripts, pip installs, and relay tools
        $guestshell_1   = "guestshell enable" ascii nocase
        $guestshell_2   = "guestshell run" ascii nocase
        
        // --- SNMP exploitation (T1602) ---
        // SNMP used to extract running configurations containing credentials
        $snmp           = "snmp-server community" ascii nocase
        
        // --- Salt Typhoon custom tools ---
        // JumbledPath: custom packet capture/exfiltration utility (CISA)
        // STOWAWAY: Go-based SOCKS5 proxy relay tool for pivoting within Cisco Guest Shell
        $tool_1         = "JumbledPath" ascii wide nocase
        $tool_2         = "STOWAWAY" ascii wide nocase

    condition:
        filesize < 10MB and
        (
            // --- HIGH CONFIDENCE: Custom tool names (unique to Salt Typhoon) ---
            $tool_1 or
            $tool_2 or
            
            // --- MEDIUM CONFIDENCE: Attack pattern combinations ---
            // GRE tunnel + ACL change = likely exfiltration infrastructure setup
            (1 of ($gre_*) and $acl_mod) or
            // TACACS redirect + any secondary indicator = credential harvesting chain
            (1 of ($tacacs_*) and (1 of ($gre_*) or 1 of ($capture_*) or $snmp)) or
            // Guest Shell + packet capture = container-based sniffing
            (1 of ($guestshell_*) and 1 of ($capture_*)) or
            // Guest Shell + TACACS (full kill chain indicator)
            (1 of ($guestshell_*) and 1 of ($tacacs_*)) or
            
            // --- BROAD: 4+ distinct indicators in same file = high suspicion ---
            4 of them
        )
}
